<!DOCTYPE html>
<html>
<head>
<title>Gele radio</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>

body {
  font-family: Arial, Helvetica, sans-serif;	
  background-color: Dimgray;
}

h1 {
	color: GoldenRod;
	font-size: 5vw;
    margin-left: 15px;
}

ul {
  margin:0;
  padding:0;
  margin-top:20px;
  width: 100%;
}

li {
  cursor:move;
  display:block;
  /*width: 240px;*/
  width:  90%;
  height: 25px;
  line-height: 25px;
  padding: 5px;
  margin: 10px;
  margin-left: 8px;
  margin-right: 0px;
  margin-bottom: 6px;
  color: black;
  border-radius:10px;
  background: Dimgray;
  border:solid 1px lightgray;
}

.edit {
  display: none; /* Hidden by default */
  position: fixed; /* Stay in place */
  z-index: 1; /* Sit on top */
  padding-top: 100px; /* Location of the box */
  left: 0;
  top: 0;
  width: 100%; /* Full width */
  height: 100%; /* Full height */
  overflow: auto; /* Enable scroll if needed */
  background-color: rgb(0,0,0); /* Fallback color */
  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
}

.clickdiv{
    margin: 5px; 
    margin-top: 20px;
    padding: 10px;
    background-color: darkgray;
    border-radius: 10px;
    height: 50px;
    line-height: 25px;    
    float: left;
    font-size: 18px;
    font-weight: bold;    
}
.clickdiv:hover{
    background-color: lightgray;
}


/* Modal Content */
.edit-content {
  position: relative;
  background-color: #fefefe;
  margin: auto;
  padding: 0;
  border: 1px solid #888;
  border-radius: 5px;
  width: 70%;
  height: 50%;
  left: -10%;
  box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
}

.edit-input{
	margin: 2%;
	margin-top: 5px;
	padding: 5px;
	width: 80%; 
    color: black;
	background-color: lightgray;
	border-radius: 5px;
}

.edbutton{
  background-color: lightgray;
  border: none;
  color: black;
  padding: 1px;
  margin-top: 2px;
  margin-bottom: 3px;
  margin-left: 10px;
  margin-right: 5px;
  float: right;
  height: 20px;
  width: 20px;
  text-align: center;
  cursor: pointer;
}

.edbutton:hover {
  background-color: black;
}

.clickbutton {
  background-color: lightgray;
  border: 1px solid darkgray;
  color: black;
  padding: 1px;
  margin-top: 2px;
  margin-bottom: 3px;
  margin-left: 10px;
  margin-right: 5px;
  height: 20px;
  width: 50px;
  text-align: center;
  cursor: pointer;
}

.delbutton{
  background-color: lightgray;
  border: none;
  color: black;
  padding: 1px;
  margin-top: 2px;
  margin-bottom: 3px;
  margin-left: 10px;
  margin-right: 5px;
  float: left;
  height: 20px;
  width: 20px;
  text-align: center;
  cursor: pointer;
}

.delbutton:hover {
  background-color: red;
}

.stationbutton {
  background-color: lightgray;
  border-top: 1px solid white;
  border-left: 1px solid white;
  border-right: 1px solid GoldenRod;
  border-bottom: 1px solid GoldenRod;
  color: white;
  padding: 5px;
  margin-top: 2px;
  margin-bottom: 3px;
  margin-left: 10px;
  margin-right: 30px;
  height: 20px;
  width: 20px;
  float: left;
  cursor: pointer;
}



.playing {
  margin: 5px;
  margin-top: 10px;
  padding: 5px;	
  width: 90%;
  color: black;
  font-weight: bold;border:1px solid gray;
  background-color: GoldenRod;
  text-align: center;
  border-radius: 10px;
}

.setvolume {
  margin: 5px;
  margin-top: 10px;
  width:  90%;  
  padding: 5px;	
  background-color: white;
  border-radius: 10px;
  text-align: center;
}

.settone{
  margin: 5px;
  margin-top: 10px;
  width:  90%;  
  padding: 5px;	
  background-color: darkgray;
  border-radius: 10px;
  text-align: center;
  overflow: auto;
}

.modeclick{ 
    border: 3px solid CornflowerBlue;
    height: 30px;
    line-height: 30px;
    margin-top: 2px;
    margin-left: 15px;
    margin-right: auto;
    /* display: none;*/
/*    if mode buttons should not be visible and working uncomment this,
      and comment out  setup_modediv(); below */
}


.slidecontainer {
  width: 95%;
  margin: 5px;
  margin-top: 10px;
  margin-left: 10px;
}

.tonecontainer {
  width: 70%;
  margin: 5px;
  margin-top: 10px;
  margin-left: 5px;
  clear: left;
  float: left;  
}

.spatialcontainer {
  width: 20%;
  margin: 1px; 
 /* margin-top: 7px;  */
  margin-left: 5px;
  padding: 120px 0;
  float: right;
  border-radius: 10px;
  background-color: lightgray;  
}

.slidervalue {
    width: 50px;
    margin: 2px;
    margin-left: auto; 
    margin-right: auto;
    padding: 0px;
    border-radius: 10px;
    border: 0px none;
    font-size: 14px;
    font-weight: bold;   
}

.voltonetxt{
    width: 100%;
    margin-left: auto; 
    margin-right: auto;
    font-size: 14px;
    font-weight: bold;    
}

.slider.slider {
  -webkit-appearance: none;
  width: 100%;
  height: 25px;
  border-radius: 10px;
  background: #d3d3d3;
  outline: none;
  opacity: 0.7;
  -webkit-transition: .2s;
  transition: opacity .2s;
}

.slider:hover {
  opacity: 1;
}

.slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 30px;
  height: 30px;
  border-radius: 10px;
  background: GoldenRod;
  cursor: pointer;
}

.slider::-moz-range-thumb {
  width: 30px;
  height: 30px;
  border-radius: 10px;
  background: GoldenRod;
  cursor: pointer;
}

</style>
<script>
ESPurl = "/"
fromdisk = false;
var jstations;
var jstatus;
var dragging = null;
pageURL = window.location;
console.log( pageURL );
var esource = false;
var metakeepalive;

if ( fromdisk ){
	//var sstations = '{ "date" : "Tue Jul  2 20:17:54 2019", "stations" : [	{	 "name" : "NPO Radio 1",	 "host" : "icecast.omroep.nl",	 "path" : "/radio1-bb-aac",	 "port" : 80 },	{	 "name" : "NPO Radio 2",	 "host" : "icecast.omroep.nl",	 "path" : "/radio2-bb-aac",	 "port" : 80 },	{	 "name" : "NPO 3fm",	 "host" : "icecast.omroep.nl",	 "path" : "/3fm-bb-aac",	 "port" : 80 },	{	 "name" : "NPO Radio 4",	 "host" : "icecast.omroep.nl",	 "path" : "/radio4-bb-aac",	 "port" : 80 },	{	 "name" : "NPO Radio 5",	 "host" : "icecast.omroep.nl",	 "path" : "/radio5-bb-aac",	 "port" : 80 },	{	 "name" : "NPO Radio 6",	 "host" : "icecast.omroep.nl",	 "path" : "/radio6-bb-aac",	 "port" : 80 },	{	 "name" : "Jazz",	 "host" : "streams.greenhost.nl",	 "path" : "/jazz",	 "port" : 8080 },	{	 "name" : "Hardbop",	 "host" : "streams.greenhost.nl",	 "path" : "/hardbop",	 "port" : 8080 },	{	 "name" : "JazzNotJazz",	 "host" : "streams.greenhost.nl",	 "path" : "/jazznotjazz",	 "port" : 8080 },	{	 "name" : "BBC 1",	 "host" : "bbcmedia.ic.llnwd.net",	 "path" : "/stream/bbcmedia_radio1_mf_q",	 "port" : 80 },	{	 "name" : "BBC 2",	 "host" : "bbcmedia.ic.llnwd.net",	 "path" : "/stream/bbcmedia_radio2_mf_q",	 "port" : 80 },	{	 "name" : "BBC 3",	 "host" : "bbcmedia.ic.llnwd.net",	 "path" : "/stream/bbcmedia_radio3_mf_q",	 "port" : 80 },	{	 "name" : "BBC 4",	 "host" : "bbcmedia.ic.llnwd.net",	 "path" : "/stream/bbcmedia_radio4fm_mf_q",	 "port" : 80 },	{	 "name" : "BBC 1xtra",	 "host" : "bbcmedia.ic.llnwd.net",	 "path" : "/stream/bbcmedia_radio1xtra_mf_p",	 "port" : 80 },	{	 "name" : "FUNX",	 "host" : "icecast.omroep.nl",	 "path" : "/funx-slowjamz-sb-aac",	 "port" : 80 }	]}';
	var sstations = '{ "date" : "Tue Jul  2 20:17:54 2019", "stations" : [	{	 "name" : "NPO Radio 1",	 "host" : "icecast.omroep.nl",	 "path" : "/radio1-bb-aac",	 "port" : 80 },	{	 "name" : "NPO Radio 2",	 "host" : "icecast.omroep.nl",	 "path" : "/radio2-bb-aac",	 "port" : 80 },	{	 "name" : "NPO 3fm",	 "host" : "icecast.omroep.nl",	 "path" : "/3fm-bb-aac",	 "port" : 80 },	{	 "name" : "NPO Radio 4",	 "host" : "icecast.omroep.nl",	 "path" : "/radio4-bb-aac",	 "port" : 80 }]}';

	var jstations = JSON.parse( sstations );
}


document.addEventListener('dragstart', function(event) {
    var target = getLI( event.target );
    dragging = target;
    event.dataTransfer.setData('text/plain', null);
    event.dataTransfer.setDragImage(self.dragging,0,0);
});

document.addEventListener('dragover', function(event) {
    event.preventDefault();
    var target = getLI( event.target );
	if ( typeof target === 'object'  ){
		next = 0;
		prev = 0;
		if ( target.nextSibling ) next = target.nextSibling;	
		if ( target.previousSibling ) prev = target.previousSibling;	
		//if ( typeof prev === 'object'  )document.getElementById( "Yoff").innerHTML =   target.id;
		//if ( typeof next === 'object'  )document.getElementById( "Ynext").innerHTML =  next.id;
		
		if ( target != dragging ){
			var bounding = target.getBoundingClientRect();
			var offset = bounding.y + (bounding.height/2);
			if ( event.clientY - offset >= 0 ) {
				if ( next != dragging ){
					target.style['border-bottom'] = 'solid 50px lightgray';
					target.style['border-top'] = '';
				}
			} else {
				if ( prev != dragging ){		
					target.style['border-top'] = 'solid 50px lightgray';
					target.style['border-bottom'] = '';
				}
			}
		}
	}
});

document.addEventListener('dragleave', function(event) {
    var target = getLI( event.target );
	if ( target ){
		target.style['border-bottom'] = '';
		target.style['border-top'] = '';
	}
});

document.addEventListener('drop', function(event) {
    event.preventDefault();
    var target = getLI( event.target );
	if ( target ){
		if ( target.style['border-bottom'] !== '' ) {
			target.style['border-bottom'] = '';
			target.parentNode.insertBefore(dragging, event.target.nextSibling);
		} else {
			target.style['border-top'] = '';
			target.parentNode.insertBefore(dragging, event.target);
		}
	}
	listList();
});

//--------------------------------------------------------------------------------
function refreshlist(){
	deleteList();
	loadlist();	
}

//--------------------------------------------------------------------------------
function upload_stations ( newstations, changestation ){
var fd = new FormData();


fd.append("changestation", changestation );
fd.append("ESPfilename", "/stations.json");

var blob = new Blob([ newstations ], { type: "application/json"});

fd.append("/stations.json", blob);

var request = new XMLHttpRequest();
request.open("POST", "/upload?filename=/stations.json");
request.onreadystatechange = function() {
			if ( request.readyState == 4 && request.status == 200 ) {
					setTimeout( refreshlist, 700);
			}
}

request.send(fd);

	
}
//--------------------------------------------------------------------------------

function listList(){
	var l = document.getElementById( 'list');
	var d = new Date();
	var datum = d.toString();
	var changeneeded = false;
	var newstations = '{ "date": ' + '"' + datum + '", "stations" : ['; 
	var changestation=-1;
	
	console.log('------------------------------');
	var items = l.getElementsByTagName("li");
	for (var i = 0; i < items.length; ++i) {
			idx = parseInt( items[i].id.slice(1) ); 	
			console.log( jstations.stations[idx].name );
			
			newstations += '{ "name" : "' + jstations.stations[ idx ].name;
			newstations += '", "protocol" : ' + jstations.stations[ idx ].protocol;
			newstations += ', "host" : "'   + jstations.stations[ idx ].host;
			newstations += '", "path" : "'   + jstations.stations[ idx ].path;
			newstations += '", "port" : '    + jstations.stations[ idx ].port;
			newstations += ', "position" : '    + jstations.stations[ idx ].position;
			newstations += '},';
					 
			if ( idx != i ){
				console.log('Station '+ jstations.stations[ idx ].name + ' needs change');
				changeneeded = true;
				if ( idx == jstatus.currentStationIndex ){
					changestation = i;
				}
				
				
			}
	}
	console.log('------------------------------');
	newstations = newstations.replace(/.$/," ")
	newstations += ']}';
	console.log( newstations );
	if ( changeneeded ){
		upload_stations( newstations, changestation );
	}
}


//--------------------------------------------------------------------------------

function getLI( target ) {
    while ( target.nodeName.toLowerCase() != 'li' && target.nodeName.toLowerCase() != 'body' ) {
        target = target.parentNode;
    }
    if ( target.nodeName.toLowerCase() == 'body' ) {
        return false;
    } else {
        return target;
    }
}
//--------------------------------------------------------------------------------

function delclick( e ){
	var element  = e.target;
	var thisidx  = document.getElementById("edidx").value;

	console.log( 'del element ' + element.id );
	console.log( 'delete idx ' + thisidx );

if ( fromdisk ){	
	console.log( 'delete ' + jstations.stations[thisidx].name);
}else{
	playingStation = jstatus.currentStationIndex;

	if ( thisidx == playingStation){
		sendcommand( 'set?station='+0 );
	}

	sendcommand( 'del?index='+thisidx+'&name='+ encodeURIComponent(jstations.stations[ thisidx ].name) ) ;
	
}

document.getElementById("ed").style.display = "none";

}

//--------------------------------------------------------------------------------

function toblack( e ){
	e.target.style.color = "black";
}
/*--------------------------------------------------*/
function toorange ( e ){
	event.target.style['background-color'] = 'GoldenRod';
}
/*--------------------------------------------------*/
function tolightyellow ( e ){
	idx = event.target.id.slice(1);
	if ( idx != jstatus.currentStationIndex ){
		event.target.style['background-color'] = 'lightyellow';
	}
}
//--------------------------------------------------------------------------------

function  uploadfile(){

 uplform = document.getElementById("uploadform");
 
 var upl = new FormData( uplform );
 upl.append('blob', uploadf );
 //upl.append('filename', uploadfname);

  var xhr = new XMLHttpRequest();
  textname = encodeURIComponent(document.getElementById("uploadfname").value);
  // Add any event handlers here...
  xhr.open("POST", '/upload?filename=' + textname );
  //xhr.open("POST", '/upload');
  console.log( encodeURIComponent(document.getElementById("uploadfname").value) );
  xhr.onreadystatechange = function() {
			if ( xhr.readyState == 4 ){
				if ( xhr.status == 200 ) {
					document.getElementById( "uploadr").innerHTML = "upload ok";
					console.log("upload ok");	
				}else{
					document.getElementById( "uploadr").innerHTML = "upload failed";
					console.log("upload failed");	
				}
			}
  }

  xhr.send( upl );

}

//--------------------------------------------------------------------------------

function reloadpage(){
	window.location.reload(true);
}

//--------------------------------------------------------------------------------
function changeupdater(){
	document.getElementById("updater").innerHTML = '';
}
//--------------------------------------------------------------------------------

function  updatefw(){

 updform = document.getElementById("updateform");
 
 var upd = new FormData( updform );
 upd.append('update', update);

  var xhr = new XMLHttpRequest();
  
  xhr.onreadystatechange = function() {
			if ( xhr.readyState == 4 ){
				if ( xhr.status == 200 ) {
					document.getElementById( "updater").innerHTML = "update ok";
					console.log("update ok");	

					uk= document.getElementById("updatek");
					uk.innerHTML = 'Rebooting...';
					uk.style.background= 'GoldenRod';
					setTimeout( reloadpage, 15000 );

				}else{
					document.getElementById( "updater").innerHTML = "update failed";
					console.log("update failed");
					
					setTimeout( reloadpage, 3000 );

				}
			}
  }
  xhr.open("POST", '/update' );
  xhr.send( upd );

}

//--------------------------------------------------------------------------------

function changeupltext()
{
pt = document.getElementById("uploadf");
ft = document.getElementById("uploadfname");
document.getElementById("uploadr").innerHTML = '';
ft.value = "/" + pt.value.replace(/^.*[\\\/]/, '');
}

//--------------------------------------------------------------------------------

function uploadclick( e ){

var element = e.target;
var elementId = element.id;	

document.getElementById("upload").style.display = "block";		
document.getElementById("uploadf").value = '';
document.getElementById("uploadfname").value = '';
document.getElementById("uploadr").innerHTML = '';
	
}
//--------------------------------------------------------------------------------

function updateclick( e ){

var element = e.target;
var elementId = element.id;	

document.getElementById("update").style.display = "block";		
document.getElementById("updatef").value = '';
document.getElementById("updater").innerHTML = '';
	
}


//--------------------------------------------------------------------------------

function rebootclick()
{

  rk = document.getElementById("rebootk");	
  
  var xhr = new XMLHttpRequest();
  
  xhr.open("GET", '/reset' );
  xhr.onreadystatechange = function() {
			if ( xhr.readyState == 4 ){
				if ( xhr.status == 200 ) {
					console.log("reset ok");	
				}else{
					console.log("reset failed");	
				}
			}
  }

  xhr.send();
  
  rk.style.background= 'GoldenRod';
  rk.innerHTML= 'rebooting...';
  
  setTimeout( reloadpage, 10000 );
}
//--------------------------------------------------------------------------------

function logclick()
{

  document.getElementById("log").style.display = "block";		
  
  logc = document.getElementById("logc");
  
  logc.innerHTML = '<button id="logclose" title="close" class="delbutton" style="float:right;">X</button><code>';
  
  var xhr = new XMLHttpRequest();
  
  xhr.open("GET", '/syslog.txt' );
  xhr.onreadystatechange = function() {
			if ( xhr.readyState == 4 && xhr.status == 200 ){
				//xhr.responseText.replace(/\n/g, "<br />");
				document.getElementById("logc").innerHTML += xhr.responseText + '</code>';
			}
  }

  xhr.send();
  
}
//--------------------------------------------------------------------------------

function statusclick()
{
 
  document.getElementById("ostatus").style.display = "block";		
  logc = document.getElementById("statusc");
  
  logc.innerHTML = '<button id="statusclose" title="close" class="delbutton" style="float:right;">X</button><code>';
  
  var xhr = new XMLHttpRequest();
  
  xhr.open("GET", '/status' );
  xhr.onreadystatechange = function() {
			if ( xhr.readyState == 4 && xhr.status == 200 ){			
				var sj = JSON.parse( xhr.responseText);
				logc.innerHTML += JSON.stringify( sj, null,'\t')  + '</code>';
			}
  }

  xhr.send();
  
}


//--------------------------------------------------------------------------------

function edclick( e ){
	var element = e.target;
	var elementId = element.id;	
	var delbut = document.getElementById("delbutton");
	var urlprotocol;
	
	if ( e.target == add ){
		thisidx = -1;
		document.getElementById("edidx").value = thisidx;
		document.getElementById("edstationbutton").innerHTML ="Add";
		document.getElementById("edstationname").value = '';
		document.getElementById("edstationurl").value = '';
		delbut.style.display="none";
	}else{
		document.getElementById("edstationbutton").innerHTML ="Change";

		thisidx   = elementId.slice(1);
		document.getElementById("edidx").value = thisidx;
	
		delbut.setAttribute('title', 'delete ' + jstations.stations[thisidx].name );  
		delbut.addEventListener("click", delclick);
		delbut.style.display="block";
		document.getElementById("edstationname").value = jstations.stations[thisidx].name;
		
		if ( jstations.stations[thisidx].protocol == 0 ){
			urlprotocol = 'http://';
			if ( jstations.stations[thisidx].port == 80 ) {
				urlport = '';
			}else{
				urlport = ':' + jstations.stations[thisidx].port;	
			}
		}
		if ( jstations.stations[thisidx].protocol == 1 ){
			urlprotocol = 'https://';
			if ( jstations.stations[thisidx].port == 443 ) {
				urlport = '';
			}else{
				urlport = ':' + jstations.stations[thisidx].port;	
			}
		}
		
		document.getElementById("edstationurl").value = urlprotocol + jstations.stations[thisidx].host + urlport + jstations.stations[thisidx].path;
	}
	
 
	document.getElementById("ed").style.display = "block";

}
//--------------------------------------------------------------------------------

function butclick( e ){
	var element = e.target;
	var elementId = element.id;

	playingStation = jstatus.currentStationIndex;
	playingElement =  document.getElementById( 's' + playingStation );
	playingElement.style['background'] = 'darkgray';
	playingElement.style['color'] = 'black';

	playingButton  =  document.getElementById( 'b' + playingStation );
	playingButton.style['background-color'] = 'lightyellow';
					
	idx   = elementId.slice(1);

	sendcommand( 'set?station='+idx );
}
//--------------------------------------------------------------------------------

function addtolist( idx ) {
  var ul = document.getElementById("list");
  var li = document.createElement("li");
  
  var but = document.createElement( "button" );
  but.setAttribute('id', 'b'+idx); 
  but.setAttribute('type', 'button'); 
  but.setAttribute('class', 'stationbutton'); 
  but.setAttribute('title', 'Play '+ jstations.stations[idx].name); 
  
  but.addEventListener("click", butclick);
  but.addEventListener("mouseover", toorange );
  but.addEventListener("mouseout", tolightyellow);
  
  li.appendChild(but);
  
  li.appendChild(document.createTextNode( jstations.stations[x].name ));
  var edbut = document.createElement( "button" );
  edbut.setAttribute('id', 'e'+idx); 
  edbut.setAttribute('type', 'button');  
  edbut.setAttribute('class', 'edbutton'); 
  edbut.setAttribute('title', 'Edit '+ jstations.stations[idx].name); 


  edbut.appendChild(document.createTextNode( '=' ));
  edbut.addEventListener("click", edclick);
  li.appendChild(edbut);	


  
  li.setAttribute("draggable", "true"); // added line
  li.setAttribute("id", "s"+idx); // added line
  ul.appendChild(li);
}

/*--------------------------------------------------*/
 function deleteList() { 
        var e = document.getElementById("list"); 
        
        //e.firstElementChild can be used. 
        var child = e.lastElementChild;  
        while (child) { 
            e.removeChild(child); 
            child = e.lastElementChild; 
        } 
} 
/*--------------------------------------------------*/
function addstation(){
  var nameE = document.getElementById("edstationname");
  var urlE = document.getElementById("edstationurl");
  var idxE = document.getElementById("edidx");

  if ( nameE.value == '' ){	
	nameE.style.color = "red";
	nameE.value = 'name?';
	return;
  }
  
  try{
	const url = new URL( urlE.value );
  }catch(e){
	urlE.style.color = "red";
	return;
  }
  
  const url = new URL( urlE.value );
  
  var protocol=0; //0 = http, 1=https
  var aport = 80;
  
  if( url.protocol === 'https:'){
	aport = 443;
	protocol = 1;
  }
  
  if ( url.port !== '' )aport = url.port;  

  command =  "add?name=" + encodeURIComponent(nameE.value);
  command += "&host=" + encodeURIComponent(url.hostname);  
  command += "&path=" + encodeURIComponent(url.pathname);
  command +=  encodeURIComponent(url.search);
  command += "&port=" + aport;
  command += "&idx=" + idxE.value;
  command += "&protocol=" + protocol;

  console.log( "/" + command );
  sendcommand( command );  
  
  urlE.value = '';
  nameE.value = '';
  document.getElementById("ed").style.display = "none";

}
/*--------------------------------------------------*/

function  sendcommand( path ){
  
	  var thttp 	 = new XMLHttpRequest();
	  
	  if ( path.substring(0, 4) === 'add?' || path.substring(0, 4) === 'del?' ){
		thttp.open("GET", ESPurl + path , true);
		thttp.responseType = 'text';
	  

		console.log('Adding station');
		thttp.onreadystatechange = function() {
			if (thttp.readyState == 4 && thttp.status == 200 ) {
					deleteList();
					setTimeout( loadlist, 1000);										
			}
		};
	  }else{
		console.log('do command');
		
		thttp.open("GET", ESPurl + path , true);
		thttp.responseType = 'text';
	  		
		thttp.onreadystatechange = function() {
			if (thttp.readyState == 4 && thttp.status == 200 ) {
					setTimeout( loadstatus, 1000);
			}
		};
	  }
	  thttp.send();
}

//--------------------------------------------------

function act_on_jstatus( jstatus ){

    curstation = document.getElementById( "current_station_name");
    curstation.innerHTML = '';
    curstation.appendChild(document.createTextNode( jstatus.currentStation ));
    
    var playingElement;
    var playingButton;
    playingStation = jstatus.currentStationIndex;
    
    for( x in jstations.stations ){
        if ( x == playingStation ){
            playingElement =  document.getElementById( 's' + x );
            playingElement.style['background'] = 'GoldenRod';
            playingElement.style['color'] = 'black';
    
            playingButton  =  document.getElementById( 'b' + x );
            playingButton.style['background-color'] = 'GoldenRod';

        }else{
            playingElement =  document.getElementById( 's' + x );
            playingElement.style['background'] = 'darkgray';
            playingElement.style['color'] = 'black';
    
            playingButton  =  document.getElementById( 'b' + x );
            playingButton.style['background-color'] = 'lightyellow';

        }
    }
    
    selectinput = jstatus.inputSelect;
    if ( selectinput != 1 ){
        document.getElementById("selectinput").style.display = "none";
    }
    
    document.getElementById("volume").value      = jstatus.currentVolume;
    document.getElementById("volumevalue").innerHTML = jstatus.currentVolume;
    
    tonevalue = jstatus.currentTone;
    
    ta = parseInt( tonevalue.substring(0,1), 16 );
    
    // in ta the register value
    if ( ta > 7 ){ 
        ta = ta - 8;
    } else {
        ta = ta + 8; 
    }    
    // now in ta the step value
    
    //tav contains the amplification/attenuation treble
    tav = -12 + (ta*1.5);
    
    tl = parseInt( tonevalue.substring(1,2), 16 ) *1000;
    ba = parseInt( tonevalue.substring(2,3), 16 );
    bl = parseInt( tonevalue.substring(3), 16 ) * 10;

    document.getElementById("treblevolvalue").innerHTML = tav;
    document.getElementById("treblevolume").value       = ta;
    
    document.getElementById("treblelimvalue").innerHTML = tl;
    document.getElementById("treblelimit").value        = tl;
    
    document.getElementById("bassvolvalue").innerHTML = ba;
    document.getElementById("bassvolume").value       = ba;
    
    document.getElementById("basslimvalue").innerHTML = bl;
    document.getElementById("basslimit").value        = bl;
    
    spatialvalue = jstatus.currentSpatial;
    document.getElementById("spatial"+spatialvalue).checked = true;
    
    for( i = 0; i<5; ++i ){           
        var img = document.getElementById("modeimg"+i);
        if ( img ){
            var thisid = img.id;
            var thismode = thisid.slice(-1);
            
            if ( thismode == jstatus.currentMode){
                img.style.backgroundColor = img.pressed_color;
            }else{
                img.style.backgroundColor = img.normal_color;
            }
        }
    }
					

}

 //--------------------------------------------------------
function initEventSource( ){
        
        if ( typeof esource == 'object' ){
            console.log ( 'typeof esource '+ typeof esource );
            console.log('adding event source if necessary');
            if ( esource.readyState != 2 )return;
            esource = new EventSource('/radioevents');
        }else{
            console.log ( 'typeof esource '+ typeof esource );
            console.log('adding event source');
            esource = new EventSource('/radioevents');
        }

            esource.addEventListener('open', function(e) {
            console.log("Events Connected");
            
            now_playing = document.getElementById( "now_playing");
            now_playing.innerHTML = '';
            now_playing.appendChild(document.createTextNode( "-" ));
          }, false);
        
        
          esource.addEventListener('error', function(e) {
            if (e.target.readyState != EventSource.OPEN) {
              console.log("Events Disconnected");
              
              now_playing = document.getElementById( "now_playing");
              now_playing.innerHTML = '';
              now_playing.appendChild(document.createTextNode( "-- Events diconnected. Click to reconnect --" ));
            }
          }, false);

          esource.addEventListener('radiostatus', function(e) {
            console.log("radiostatus", e.data);
            
            jstatus = JSON.parse( e.data );
            act_on_jstatus( jstatus );
            
          }, false);
          
          esource.addEventListener('meta', function(e) {
            console.log("meta", e.data);
            clearTimeout( metakeepalive );
            now_playing = document.getElementById( "now_playing");
            now_playing.innerHTML = '';
            now_playing.appendChild(document.createTextNode( e.data ));
            metakeepalive = setTimeout( closeandload, 80000);
             
          }, false);
         
}        

//------------------------------------------------------------    

function getjson( path ){
  
	  var thttp 	 = new XMLHttpRequest();
	  thttp.open("GET", ESPurl + path , true);
	  
	  thttp.responseType = 'text';
	  
	  if ( path === 'stations.json' ){
		thttp.onreadystatechange = function() {
			if (thttp.readyState == 4 && thttp.status == 200 ) {
					jstations = JSON.parse(thttp.responseText);
					for( x in jstations.stations ){
							addtolist( x );
					}
                    initEventSource();
					setTimeout( loadstatus, 1000);
	
			}
		};
	  }
	  if ( path === 'status' ){
		thttp.onreadystatechange = function() {
			if (thttp.readyState == 4 && thttp.status == 200 ) { 
					jstatus = JSON.parse(thttp.responseText);
					
                    act_on_jstatus( jstatus );
                    initEventSource();

					
			}
		};
	  }
	  thttp.send();
}

function loadlist(){

		if ( fromdisk ){
			for( x in jstations.stations ){
							addtolist( x );
					}
		}else{
			getjson( 'stations.json');
		}	
}

function loadstatus(){
	getjson( 'status');
}

function closeandload(){
    console.log("close event source and load status");
    esource.close();
    now_playing = document.getElementById( "now_playing");
    now_playing.innerHTML = '';
    now_playing.appendChild(document.createTextNode( "-- Radio may be off, please check. Then click to reconnect --" ));
    loadstatus();
}

</script>
</head>
<body>
<h1>Gele radio</h1>


<div id="left" style="margin: 10px;width: 80%; float: left; clear: left;">

    <div class="settone" style="background-color: Dimgray;" id="selectinput">
        <div class="clickdiv modeclick" id="modeimg4">Line in</div>
        <div class="clickdiv modeclick" id="modeimg3">Bluetooth</div>
        <div class="clickdiv modeclick" id="modeimg0">Webradio</div>
        <div class="clickdiv modeclick" id="modeimg2">Poweroff</div>
    </div>    

    <div id="current" class="playing"><div id="current_station_name">Playing station</div><div id="now_playing" class="voltonetxt">-</div> </div>

    <div class="setvolume" title="Change volume">
        <div class="slidecontainer">
            <div class="voltonetxt">Volume</div> 
            <div id="volumevalue" class="slidervalue"></div>
            <input type="range" min="40" max="100" value="75" class="slider" id="volume">
        </div>
    </div>
    <div class="settone" title="Tone control">
        <div class="spatialcontainer">
            <div class="voltonetxt">3D effect</div> 
            <input type="radio" id="spatial0" name="earphone" value="0">
            <label for="spatial0">0</label><br>
            <input type="radio" id="spatial1" name="earphone" value="1">
            <label for="spatial1">1</label><br>
            <input type="radio" id="spatial2" name="earphone" value="2">
            <label for="spatial2">2</label><br>
            <input type="radio" id="spatial3" name="earphone" value="3">
            <label for="spatial3">3</label><br>
        </div>
        <div class="tonecontainer" title="Highest bass frequency" >
            <div class="voltonetxt">Highest bass frequency (Hz)</div> 
            <div id="basslimvalue" class="slidervalue"></div>
            <input type="range" min="0" max="150" value="130" step="10" class="slider" id="basslimit">
        </div>
        <div class="tonecontainer" title="Bass enhancement (dB)">
            <div class="voltonetxt">Bass enhancement (dB)</div> 
            <div id="bassvolvalue" class="slidervalue"></div>
            <input type="range" min="0" max="15" value="0" step="1" class="slider" id="bassvolume">
        </div>
        <div class="tonecontainer" title="Lowest treble frequency (Hz)">
            <div class="voltonetxt">Lowest treble frequency (Hz)</div> 
            <div id="treblelimvalue" class="slidervalue"></div>
            <input type="range" min="0" max="15000" value="2000" step="1000" class="slider" id="treblelimit">
        </div>
        <div class="tonecontainer" title="Treble enhancement (dB)">
            <div class="voltonetxt">Treble attenuation/amplification (dB)</div> 
            <div id="treblevolvalue" class="slidervalue">0</div>
            <input type="range" min="0" max="15" value="8" step="1" class="slider" id="treblevolume">
        </div>
     
    </div>



    <div>
    <ul id="list"></ul> 
    </div>



    <div id="ed" class="edit">
        <div id="edc" class="edit-content">
            <button id="edclose" 	   title="close" class="delbutton" style="float:right;">X</button>
            <span style="height: 10px; font-size: 14px; color: darkgray;">name</span>
            <br />
            <input id="edstationname"  type="text"  class="edit-input" style="height: 20%; font-size: 40px; text-align: center;" value="name"> </input>
            <br />
            <span style="height: 10px; font-size: 14px; color: darkgray;">url</span>
            <br />
            <input id="edstationurl"   type="text"  class="edit-input" style="height: 15%; font-size: 18px;" value="url"> </input>
            <br />
            <button id="delbutton" 		 type="button" class="delbutton" style="margin-top: 2%;">| |</button>
            <button id="edstationbutton" type="button" class="clickbutton" style="float:right;margin-top: 2%;" onclick="addstation()" >Save</button> 
            <button id="edidx" style="display: none;"></button>
            
        </div>
    </div>


    <div id="upload" class="edit">
        <div id="uploadc" class="edit-content">
            <button id="uploadclose" 	   title="close" class="delbutton" style="float:right;">X</button>
            <div style="margin: 20px; margin-left: 10px; padding: 10px;height: 20px; font-size: 20px; color: darkgray;">Upload file</div>
            <br />
            <form id="uploadform" action="/upload" enctype="multipart/form-data">
                <input id="uploadf"  type="file"  class="edit-input" style="font-size: 14px;" name="blob" onchange="changeupltext(event)"> </input>
            <br />
                <input id="uploadfname"   type="text"  class="edit-input" style="height: 18px; font-size: 14px;" name="filename"></input>
            </form>
            <br />
            <button id="uploadbutton" type="button" class="clickbutton" style="float:right; margin-right:10px;" onclick="uploadfile()" >Upload</button> 
            <div id="uploadr" style="margin-left: 20px; height: 10px; font-size: 14px; color: black;"></div>
        </div>
    </div>

    <div id="update" class="edit">
        <div id="updatec" class="edit-content">
            <button id="updateclose" 	   title="close" class="delbutton" style="float:right;">X</button>
            <div style="margin: 10px; margin-left: 10px; padding: 10px;height: 20px; font-size: 20px; color: darkgray;">Update firmware</div>
            <br />
            <form id="updateform" action="/update" enctype="multipart/form-data">
                <input id="updatef"  type="file"  class="edit-input" style="font-size: 14px;" name="update" onfocus="changeupdater(event)"> </input>		
            </form>
            <br />
            <button id="updatebutton" type="button" class="clickbutton" style="float:right;" onclick="updatefw()" >Update</button> 
            <div id="updater" style="margin-left: 20px; height: 10px; font-size: 14px; color: black;"></div>
        </div>
    </div>

    <div id="log" class="edit">
        <div id="logc" class="edit-content" style="font-family: monospace; white-space: pre; overflow: scroll;">
            <button id="logclose" 	   title="close" class="delbutton" style="float:right;">X</button>		
        </div>
    </div>

    <div id="ostatus" class="edit">
        <div id="statusc" class="edit-content" style="font-family: monospace; white-space: pre; overflow: scroll;">
            <button id="statusclose" 	   title="close" class="delbutton" style="float:right;">X</button>		
        </div>
    </div>


</div>



<div id="add" class="clickdiv">
Add<br />Station 
</div>
<div id="logk" class="clickdiv">
Show<br />log		
</div>
<div id="statusk" class="clickdiv">
Show<br />status		
</div>
<div id="uploadk" class="clickdiv">
Upload<br />file		
</div>
<div id="updatek" class="clickdiv">
Update<br />firmware
</div>
<div id="rebootk" class="clickdiv">
Reboot
</div>

<script>
	setTimeout( loadlist, 1000);
</script>
<script>

function setup_slider( sliderobj, outputobj ){

      if ( sliderobj.id !== 'treblevolume'){  
        outputobj.innerHTML = sliderobj.value;
      }else{
        // tav contains th db of attenuation/amplification
        ta = sliderobj.value;
        tav = -12 + ( ta * 1.5 );      
        outputobj.innerHTML =  tav;
      }

    sliderobj.oninput = function() {
      if ( sliderobj.id !== 'treblevolume'){  
        outputobj.innerHTML = this.value;
      }else{
        // tav contains th db of attenuation/amplification
        ta = this.value;
        tav = -12 + ( ta * 1.5 );      
        outputobj.innerHTML =  tav;

      }
        
    };
    sliderobj.outputobj = outputobj;

    sliderobj.onmouseup =function slideOut( e ) {
     
      e.target.outputobj.style['background'] = 'GoldenRod';
      setTimeout( function( a ){ a.style['background'] = a.parentNode.style['background'] ; } ,1000, e.target.outputobj );
      if ( sliderobj.id === 'volume' ) {
        sendcommand( 'set?volume='+ this.value );
      }else{
        ta = document.getElementById("treblevolume").value;
        tl = document.getElementById("treblelimit").value / 1000;
        ba = document.getElementById("bassvolume").value;
        bl = document.getElementById("basslimit").value / 10;
        
        // tav contains th db of attenuation/amplification
        tav = -12 + ( ta * 1.5 );
        //ta contains the step value
        if ( ta < 8 ){
           ta = parseInt(ta,10) + 8;
        }else{
           ta = ta - 8;
        }
        // now ta contains the register value 
            
        
        console.log( "treblelimit : " + document.getElementById("treblelimit").value );
        console.log( "registervalue treblevolume : " + ta + " db's "+ tav  );
        console.log( "basslimit : " + document.getElementById("basslimit").value );
        console.log( "treblevolume : " + document.getElementById("treblevolume").value );
        console.log( "bassvolume : " + document.getElementById("bassvolume").value );
    
        console.log(ta, tl, ba, bl);    
        
        tonevalue = "";
        tonevalue += parseInt(ta,10).toString(16);
        tonevalue += parseInt(tl,10).toString(16);
        tonevalue += parseInt(ba,10).toString(16);       
        tonevalue += parseInt(bl,10).toString(16);
        
        console.log( tonevalue );    
        
        sendcommand( 'set?tone='+ tonevalue );    
      }  
    }
    sliderobj.ontouchend = sliderobj.onmouseup;
}

setup_slider( document.getElementById("volume"), document.getElementById("volumevalue") ); 
setup_slider( document.getElementById("basslimit"), document.getElementById("basslimvalue") ); 
setup_slider( document.getElementById("bassvolume"), document.getElementById("bassvolvalue") ); 
setup_slider( document.getElementById("treblelimit"), document.getElementById("treblelimvalue") ); 
setup_slider( document.getElementById("treblevolume"), document.getElementById("treblevolvalue") ); 

function setup_spatial(){
    
    for ( i = 0; i < 4; ++i ){
        document.getElementById("spatial"+i).onclick=function setspatial(e){
            value = e.target.value;
            console.log( "spatial ", value);
            sendcommand( 'set?spatial='+ value );
        }
        
    }    
}

setup_spatial();

function setup_modediv(){
    for( i = 0; i<5; ++i ){
        var img = document.getElementById("modeimg"+i);
        if ( img ){
            img.pressed = false;
            img.normal_color  = img.style.backgroundColor;
            img.pressed_color = "GoldenRod";
            img.onclick=function setmode(e){
                var thisid = e.target.id;
                console.log("clicked "+ thisid);
                var newmode = thisid.slice(-1);
                e.target.style.backgroundColor = img.pressed_color;
                sendcommand( 'set?mode='+ newmode );
            }
        }
    }    
}

// comment out if mode switches should not work and also
// add display:none; to the .modeclick css definition
setup_modediv();


function hideed(event) {
  if (event.target == ed || event.target == edclose) {
    document.getElementById("ed").style.display = "none";
  }

  if (event.target == upload || event.target == uploadclose) {
    document.getElementById("upload").style.display = "none";
  }

  if (event.target == update || event.target == updateclose) {
    document.getElementById("update").style.display = "none";
  }
  
  if (event.target == log || event.target == logclose) {
    document.getElementById("log").style.display = "none";
  }
  if (event.target == ostatus || event.target == statusclose) {
    document.getElementById("ostatus").style.display = "none";
  }


}

window.onclick=hideed;
document.getElementById("edclose").onclick=hideed;

function redout(){
  output.style['background'] = '';
}

document.getElementById("current").onclick=closeandload; 

document.getElementById("add").onclick=edclick;
document.getElementById("uploadk").onclick=uploadclick;
document.getElementById("updatek").onclick=updateclick;
document.getElementById("rebootk").onclick=rebootclick;
document.getElementById("logk").onclick=logclick;
document.getElementById("statusk").onclick=statusclick;


var eUrl  = document.getElementById("edstationurl"); 
var eName = document.getElementById("edstationname");
	
eUrl.addEventListener("focus",toblack);
eName.addEventListener("focus",toblack);
	


</script>

</body>
</html>